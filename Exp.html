<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monthly Budget Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4">
    <!-- Settings Card -->
    <div class="bg-white shadow-md rounded-2xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Budget Settings</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block mb-1">Monthly Budget (₹)</label>
          <input id="budgetInput" type="number" class="w-full border rounded p-2" placeholder="e.g. 30000" />
        </div>
        <div>
          <label class="block mb-1">Start Date</label>
          <input id="startDateInput" type="date" class="w-full border rounded p-2" />
        </div>
        <div class="flex items-end">
          <button id="initBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Initialize</button>
        </div>
      </div>
    </div>

    <!-- Main Tracker -->
    <div id="tracker" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Add Expense Card -->
        <div class="bg-white shadow-md rounded-2xl p-6">
          <h3 class="text-lg font-medium mb-4">Add Expense</h3>
          <div class="space-y-3">
            <input id="expenseDate" type="date" class="w-full border rounded p-2" />
            <input id="expenseName" type="text" class="w-full border rounded p-2" placeholder="Item Name" />
            <input id="expenseAmount" type="number" class="w-full border rounded p-2" placeholder="Amount ₹" />
            <button id="addExpenseBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Expense</button>
          </div>
        </div>

        <!-- Budget Overview Card -->
        <div class="bg-white shadow-md rounded-2xl p-6 h-full">
          <h3 class="text-lg font-medium mb-4">Overview</h3>
          <p class="text-gray-700 mb-2">Remaining Budget: <span id="remainingBudget" class="font-semibold"></span></p>
          <canvas id="spendingChart"></canvas>
        </div>
      </div>

      <!-- Expense Table and Actions -->
      <div class="bg-white shadow-md rounded-2xl p-6 mt-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium">Expenses</h3>
          <div class="space-x-2">
            <button id="downloadBtn" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">Download Excel</button>
            <button id="resetBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Reset</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full table-auto">
            <thead>
              <tr class="bg-gray-100">
                <th class="p-2">Date</th>
                <th class="p-2">Item</th>
                <th class="p-2">Amount (₹)</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="expenseTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
      <div class="bg-white rounded-2xl shadow-lg p-6 w-96">
        <h3 class="text-lg font-medium mb-4">Edit Expense</h3>
        <input id="editDate" type="date" class="w-full border rounded p-2 mb-3" />
        <input id="editName" type="text" class="w-full border rounded p-2 mb-3" />
        <input id="editAmount" type="number" class="w-full border rounded p-2 mb-4" />
        <div class="flex justify-end space-x-2">
          <button id="cancelEditBtn" class="px-4 py-2 rounded bg-gray-300">Cancel</button>
          <button id="saveEditBtn" class="px-4 py-2 rounded bg-blue-500 text-white">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let budget = 0;
    let startDate;
    let expenses = [];
    let autoTransportDone = false;
    let editIndex = null;
    const STORAGE_KEY = 'monthlyBudgetTracker';

    const trackerEl = document.getElementById('tracker');
    const remainingEl = document.getElementById('remainingBudget');
    const tableBody = document.getElementById('expenseTable');
    const chartCtx = document.getElementById('spendingChart').getContext('2d');
    let lineChart;

    document.getElementById('initBtn').addEventListener('click', initializeTracker);
    document.getElementById('addExpenseBtn').addEventListener('click', addExpense);
    document.getElementById('downloadBtn').addEventListener('click', exportExcel);
    document.getElementById('resetBtn').addEventListener('click', resetTracker);
    document.getElementById('cancelEditBtn').addEventListener('click', () => toggleEditModal(false));
    document.getElementById('saveEditBtn').addEventListener('click', saveEdit);

    document.addEventListener('DOMContentLoaded', () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        loadState();
        document.getElementById('budgetInput').value = budget;
        document.getElementById('startDateInput').value = startDate;
        initializeTracker();
      }
    });

    function initializeTracker() {
      budget = parseFloat(document.getElementById('budgetInput').value) || budget;
      startDate = document.getElementById('startDateInput').value || startDate;
      if (!budget || !startDate) return;
      trackerEl.classList.remove('hidden');
      if (!autoTransportDone) {
        autoAddTransport();
        autoTransportDone = true;
      }
      renderAll();
      saveState();
    }

    function addExpense() {
      const date = document.getElementById('expenseDate').value;
      const name = document.getElementById('expenseName').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      if (!date || !name || !amount) return;
      expenses.push({ date, name, amount });
      renderAll();
      saveState();
    }

    function saveEdit() {
      const d = document.getElementById('editDate').value;
      const n = document.getElementById('editName').value;
      const a = parseFloat(document.getElementById('editAmount').value);
      if (editIndex !== null && d && n && a) {
        expenses[editIndex] = { date: d, name: n, amount: a };
        toggleEditModal(false);
        renderAll();
        saveState();
      }
    }

    function toggleEditModal(show, idx = null) {
      document.getElementById('editModal').classList.toggle('hidden', !show);
      if (show) {
        editIndex = idx;
        const exp = expenses[idx];
        document.getElementById('editDate').value = exp.date;
        document.getElementById('editName').value = exp.name;
        document.getElementById('editAmount').value = exp.amount;
      }
    }

    function renderAll() {
      expenses.sort((a,b)=>new Date(a.date)-new Date(b.date));
      renderTable(); renderRemaining(); renderChart();
    }

    function renderTable() {
      tableBody.innerHTML='';
      expenses.forEach((e,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${e.date}</td><td class="p-2">${e.name}</td><td class="p-2">₹${e.amount.toFixed(2)}</td><td class="p-2 space-x-2"><button onclick="editExpense(${i})" class="text-blue-500">Edit</button><button onclick="deleteExpense(${i})" class="text-red-500">Delete</button></td>`;
        tableBody.appendChild(tr);
      });
    }

    window.editExpense=idx=>toggleEditModal(true,idx);
    window.deleteExpense=idx=>{ expenses.splice(idx,1); renderAll(); saveState(); };

    function renderRemaining() {
      const spent=expenses.reduce((s,e)=>s+e.amount,0);
      remainingEl.textContent=`₹${(budget-spent).toFixed(2)}`;
    }

    function renderChart(){
      const daily={};
      expenses.forEach(e=>daily[e.date]=(daily[e.date]||0)+e.amount);
      const labels=Object.keys(daily);
      const data=labels.map(d=>daily[d]);
      if(lineChart)lineChart.destroy();
      lineChart=new Chart(chartCtx,{type:'line',data:{labels,datasets:[{label:'Daily Spending',data,fill:false}]}});
    }

    function autoAddTransport(){
      const start=new Date(startDate),end=new Date(start);
      end.setMonth(end.getMonth()+1);
      for(let d=new Date(start);d<end;d.setDate(d.getDate()+1)){
        const day=d.getDay();
        if(day>0&&day<6){
          const dateStr=d.toISOString().split('T')[0];
          expenses.push({date:dateStr,name:'Transport to college',amount:15});
        }
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY,JSON.stringify({budget,startDate,expenses,autoTransportDone}));
    }

    function loadState(){
      const data=JSON.parse(localStorage.getItem(STORAGE_KEY));
      budget=data.budget;startDate=data.startDate;expenses=data.expenses||[];autoTransportDone=data.autoTransportDone||false;
    }

    function exportExcel(){
      const wb=XLSX.utils.book_new(),grouped={};
      expenses.forEach(e=>{const m=e.date.slice(0,7);(grouped[m]||(grouped[m]=[])).push({Date:e.date,Name:e.name,Amount:e.amount});});
      Object.keys(grouped).forEach(m=>{XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(grouped[m]),m)});
      XLSX.writeFile(wb,`Budget_${startDate.slice(0,7)}.xlsx`);
    }

    function resetTracker(){if(!confirm('Clear all data?'))return;localStorage.removeItem(STORAGE_KEY);location.reload();}
  </script>
</body>
</html>
''